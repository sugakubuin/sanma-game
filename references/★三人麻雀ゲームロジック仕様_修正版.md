# 三人麻雀ゲームロジック仕様（完全版）

## 1. ゲーム基本設定

```
プレイヤー数: 3人
座位: 東家・南家・西家（反時計回り）
使用牌: 112枚
  - 萬子: 1,9 各4枚 (8枚)
  - 筒子: 1-9 各4枚 (36枚)
  - 索子: 1-9 各4枚 (36枚)
  - 字牌: 東南西北白發中 各4枚 (28枚)
  - 華牌: 4枚
  - 金牌: 5p、5s、花牌に各1枚 (計3枚、上記の内数)
  - 白ポッチ: 1枚 (白の内数)

配給原点: 50,000点
返し: 50,000点
ゲーム構成: 東場・南場の二場制
  - 東場: 東一局・東二局・東三局
  - 南場: 南一局・南二局・南三局

基本ルール:
  - 喰いタン: あり
  - 後付け: あり
  - ツモ平和: あり
  - チー: なし（順子の副露不可）
```

## 2. 配牌・王牌・ツモ

```
配牌: 
  - 子: 13枚
  - 親: 14枚（第一ツモ済み）
  - 親の第一打でゲーム開始

手牌: 13枚（槓1つごとに+1枚、最大17枚）

王牌: その局で自然にツモすることがない牌
  - 初期構成: 嶺上牌8枚 + ドラ表示牌1枚 + 裏ドラ表示牌1枚 = 10枚
  - 牌山の構造: [..., 海底牌, ドラ表示牌, 裏ドラ表示牌, 嶺上牌, ..., 嶺上牌]
  - 華牌抜き: 嶺上牌をツモ → 王牌-1枚
  - 槓: 嶺上牌をツモ、槓ドラ表示+1、槓裏ドラ表示+1 → 王牌+1枚
  - 最小: 6枚（華牌4枚全抜き時: 嶺上4 + ドラ表示1 + 裏ドラ表示1）
  - 最大: 14枚（槓4回時: 嶺上4 + ドラ表示5 + 裏ドラ表示5）
  
海底牌: 王牌直前の牌
  - 海底牌とその1つ前の牌をツモした者は槓不可
  
ツモ上限: 王牌の直前まで（王牌は必ず残る）

槓上限: 1局中4回まで（5回目の槓は不可）

嶺上牌: 槓子完成時または華牌抜き時に王牌最尾から順に取る
```

## 3. ドラ

```
本ドラ:
  - 王牌のドラ表示牌位置（初期は末尾2枚目）を表示
  - 次順牌がドラ
    数牌: 1→2→...→9→1
    風牌: 東→南→西→北→東
    三元牌: 白→發→中→白
    華牌: 華牌のまま

槓ドラ:
  - 槓子開示確認時点で即めくり
  - 1つ目: ドラ表示牌の隣
  - 2つ目以降: 順次隣へ
  - 槍槓で槓不成立の場合はめくらない

裏ドラ:
  - リーチでの和了時
  - すべての表ドラ表示牌の裏側（王牌末尾側）

赤ドラ:
  - 5筒・5索すべて（各4枚）
  - 1枚につき1翻

金牌:
  - 5p、5s、花牌に各1枚
  - 和了時に祝儀1枚（副露手含む）

華牌:
  - 空気扱い（手牌に入らない）
  - ツモ時に自動抜き
  - 抜いた際は嶺上牌をツモり、手牌右側に華牌を寄せる
  - 一発・海底等の状態は消えない
  - 嶺上開花はつかない
  - 王牌-1枚

ドラ計算:
  - すべてのドラは1枚1翻
  - 役とはならない
```

## 4. 副露（ポン・カン）

```
チー: なし（順子の副露不可）

ポン:
  - 他家の捨て牌に対し、手牌の対子で刻子を作る
  - 優先順位: 和了 > ポン・カン

明槓:
  - 他家の捨て牌に対し、手牌の暗刻で槓子を作る
  - 嶺上牌をツモる
  - 槓ドラ即めくり

加槓:
  - 自分のツモ番、自分の明刻に同一牌を加える
  - 嶺上牌をツモる
  - 槓ドラ即めくり

暗槓:
  - 自分のツモ番、手牌（ツモ牌含む）の4枚同一牌
  - 内側または外側2枚を伏せて表示
  - 嶺上牌をツモる
  - 槓ドラ即めくり

食い換え:
  - ポン時、副露した対子と面子を構成可能な牌の打牌は禁止
  - 違反は無効（打牌前なら訂正可能）

河底牌のポン・カン:
  - 不可
```

## 5. リーチ

```
基本条件:
  - 門前清
  - 聴牌
  - 1,000点以上の持ち点
  - ツモ番の有無は問わない
  - 海底牌をツモした者は不可

宣言手順:
  1. 「リーチ」発声
  2. 打牌を横向きに置く
  3. 1,000点棒を供託
  （3動作は一連で行う、1つでも欠けると不成立）

成立タイミング:
  - リーチ宣言牌に対してロンがなければ成立
  - ポン・カンがあった場合は次巡の打牌を横にする

リーチ後の制約:
  - アガリの見送り不可
  - 暗槓: 独立した暗刻の同一牌ツモ時のみ可（待ち変化は不問）

オープンリーチ:
  - 2翻役
  - 手牌全開け
  - 1,000点供託
  - リーチ中でない者の放銃は無効（牌を戻す）
  - 押し出し放銃（手牌すべてがオープンリーチ者の和了牌）は役満払い

フリテンリーチ:
  - 通常リーチは不可
  - オープンリーチのみ可

白ポッチ:
  - リーチ後ツモで永久オールマイティ
  - 複数和了牌がある場合は選択可
  - 和了牌に5がある場合は赤ドラとして扱える
  - 裏ドラ確認後に高目を取ることも可能
  - 金牌にはならない
  - 強制和了
```

## 6. 和了

```
和了形態:
  1. 雀頭 + 4順子
  2. 雀頭 + 3順子 + 1刻子
  3. 雀頭 + 2順子 + 2刻子
  4. 雀頭 + 1順子 + 3刻子
  5. 雀頭 + 4刻子
  6. 七対子（4枚使い含む）
  7. 十三幺九

和了成立:
  - 手牌13枚 + 1枚（ツモ牌/ロン牌）= 14枚で規定の和了形
  - 副露牌も含めて14枚で構成
  - 1翻以上の役（常時一翻縛り）

和了手段:
  - ツモ和了: 自分のツモ（嶺上牌含む）
  - ロン和了: 他家の打牌、加槓牌
  - 槍槓: 加槓牌でのロン（国士無双は暗槓も可）

和了人数: 1局最大2人（ダブロン可）
  - 放銃者は2人分の点数を支払う

フリテン:
  - 自分の捨て牌に和了形を構成できる牌がある聴牌
  - ロン和了不可
  - 通常リーチ不可（オープンリーチは可）

摸打の一巡内での和了牌選択:
  - 不可
  - 「摸打の一巡」= 自分の打牌から次回の取牌直前まで

高点法:
  - 和了形が取りうる最も高い点数を計算
```

## 7. 点数計算

```
符計算: なし（30符固定、切り上げ、ツモ損なし）

基本点数表:
翻数 | 名称   | 親ロン  | 親ツモ        | 子ロン  | 子ツモ
-----|--------|---------|---------------|---------|-------------
1翻  | -      | 2,000   | 1,000オール   | 1,000   | 1,000オール
2翻  | -      | 3,000   | 2,000オール   | 2,000   | 1,000オール
3翻  | -      | 6,000   | 3,000オール   | 4,000   | 1,000/3,000
4翻  | 満貫   | 12,000  | 6,000オール   | 8,000   | 3,000/5,000
5翻  | 満貫   | 18,000  | 9,000オール   | 12,000  | 4,000/8,000
6翻  | 跳満   | 18,000  | 9,000オール   | 12,000  | 4,000/8,000
7翻  | 跳満   | 18,000  | 9,000オール   | 12,000  | 4,000/8,000
8翻  | 倍満   | 24,000  | 12,000オール  | 16,000  | 6,000/10,000
9翻  | 倍満   | 24,000  | 12,000オール  | 16,000  | 6,000/10,000
10翻 | 三倍満 | 36,000  | 18,000オール  | 24,000  | 8,000/16,000
11翻 | 三倍満 | 36,000  | 18,000オール  | 24,000  | 8,000/16,000
12翻 | 三倍満 | 36,000  | 18,000オール  | 24,000  | 8,000/16,000
13翻 | 役満   | 48,000  | 24,000オール  | 32,000  | 12,000/20,000
14翻 | 役満   | 48,000  | 24,000オール  | 32,000  | 12,000/20,000
15翻+| 役満   | 48,000  | 24,000オール  | 32,000  | 12,000/20,000

積み棒加算:
  - ロン: 1本場につき+1,000点
  - ツモ: 1本場につき+1,000点オール

翻数計算:
  - 和了役の合計翻数 + ドラ枚数

同居役の複合: 認める（ただし海底撈月と嶺上開花は複合しない）
```

## 8. 役一覧

```
【1翻役】
- 門前清自摸和: 門前清でのツモ和了
- 立直: 門前清でリーチ宣言しての和了
- 一発: リーチ宣言から純粋な一巡以内の和了（リーチの付帯役）
- 役牌: 圏風牌・自風牌・北、または三元牌の刻子
  （北は場風・自風にならず、常に役牌として扱う）
- 平和: 門前清、4面子が順子、両面待ち、雀頭が役牌でない
- 断幺九: 中張牌のみ
- 一盃口: 門前清、2面子が同一順子
- 海底撈月: 海底牌でのツモ和了
- 河底撈魚: 河底牌でのロン和了
- 搶槓: 加槓牌でのロン和了
- 嶺上開花: 嶺上牌でのツモ和了

【2翻役】
- ダブル立直: 純粋な第一巡目での立直
- 連風牌: 連風牌（圏風=自風）の刻子
- 対々和: 4面子が刻子
- 三暗刻: 3面子が暗刻
- 三連刻: 連続した同種の数牌3面子が刻子
- 三槓子: 3面子が槓子
- 小三元: 三元牌2種が刻子、1種が雀頭（個々の翻数は含まず）
- 混老頭: 老頭牌および字牌のみ
- 三風: 風牌のうち3種が刻子
- 一気通貫: 3面子が同種の数牌で123・456・789（喰い下がり1翻）
- 全帯幺九: 4面子1雀頭すべてに幺九牌、最低1組の順子と字牌（喰い下がり1翻）
- 七対子: 7種類の対子
- オープン立直: 門前清でリーチ宣言かつ手牌全開け

【3翻役】
- 二盃口: 門前清、2組の一盃口
- 混一色: 1種類の数牌および字牌（喰い下がり2翻）
- 純全帯幺九: 4面子1雀頭すべてに老頭牌、最低1組の順子（喰い下がり2翻）

【6翻役】
- 清一色: 1種類の数牌のみ（喰い下がり5翻）
- 小車輪: 混一色七対子

【役満】
- 天和: 親の配牌での和了
- 地和: 子の純粋な第一ツモでの和了
- 人和: 副露がない状態で他家の第一打でのロン和了
- 十三幺九: 13種類14枚の幺九牌
- 四暗刻: 4面子が暗刻
- 大三元: 三元牌すべてが刻子
- 緑一色: 索子の2・3・4・6・8、および發のみ
- 字一色: 字牌のみ
- 小四喜: 四喜牌3種が刻子、1種が雀頭
- 大四喜: 四喜牌すべてが刻子
- 清老頭: 老頭牌のみ
- 四槓子: 4面子が槓子
- 九蓮宝燈: 和了形から特定1枚を除いた形が「1112345678999」の門前清一色
- 流し: 1打目から海底牌まで自分は副露せず他家も自分の牌を副露せず幺九牌のみ河に捨てて流局
- カラス: リーチのみ1翻でドラ0枚の和了
- 四連刻: 連続した同種の数牌4面子が刻子
- 大車輪: 清一色七対子
- 萬子混一色: 萬子の数牌および字牌のみ

【特殊】
- 4枚使い七対子: 七対子（2翻）+ 4枚使い1組ごとに+4翻
- 単一役のダブル役満: あり（雀魂準拠）
- 役満の複合: あり
```

## 9. 包（パオ）

```
適用役: 大三元、大四喜、四槓子、四連刻

責任:
  - ツモ和了: 包者が全額責任払い
  - ロン和了: 放銃者と包者で折半
  - 祝儀の責任払いはなし
```

## 10. 流局

```
流局条件:
  - 河底牌にロンがない
  - 途中流局なし

テンパイ宣言:
  - 手牌開示で宣言とみなす（手役の有無は問わない）
  - 順序: 東家→南家→西家
  - リーチ者は他家に先がけて開示
  - 自己の手牌および副露牌で和了牌を使い切っている場合は聴牌とならない
  - ケイテン（形式聴牌）あり
  - 純カラ（和了牌が全て見えている）も聴牌扱い

ノーテン罰符:
  - 場に2,000点
  - テンパイ1人: ノーテン者2人から各1,000点
  - テンパイ2人: ノーテン者から各1,000点ずつ
  - 3人全員テンパイまたは全員ノーテン: 点棒移動なし

流局での供託:
  - ゲーム継続の場合: 次局へ持ち越し
  - ゲーム終了の場合: トップ取り
```

## 11. 連荘・輪荘・本場

```
局番の構造:
  - 東一局、東二局、東三局、南一局、南二局、南三局
  - 各局は0本場から始まる
  - 親は常に東家

連荘（親が続投）:
  - 親の和了
  - 親の聴牌での流局
  - 本場+1、局番は変わらず
  - 例: 東一局0本場 → 東一局1本場

輪荘（親が交代）:
  - 子の和了
  - 親のノーテンでの流局
  - 親が下家（反時計回り）に移動
  - 局番+1、本場リセット
  - 例: 東一局1本場 → 東二局0本場

積み棒:
  - 本場数に応じて加算
  - 子の和了で消滅
```

## 12. 終局条件

```
通常終了:
  - 南場終了
  - オーラス（南三局以降）でトップの親のみ和了やめ・聴牌やめ選択可能
    - やめを選択: ゲーム終了
    - 続行を選択: 連荘して南三局n本場として続行

トビ終了:
  - 局終了時に0点以下のプレイヤーが発生
  - 即座に半荘終了
```

## 13. 精算

```
配給原点: 50,000点
返し: 50,000点

半荘終了時の合計点調整:
  - 3人合計が150,000点未満: そのまま有効
  - 3人合計が150,000点超過: 順位決定後、トップから超過分を差し引く

順位決定:
  - 得失点の多少で決定
  - 同点の場合: 起家に近い方が上位

ウマ:
  - 場に40pt
  - 2着が浮き(50,000点超過)の場合
    - 1着: +30pt
    - 2着: +10pt
    - 3着: -40pt
  - 2着が沈み(50,000点未満)の場合
    - 1着: +40pt
    - 2着: -10pt
    - 3着: -30pt

箱下精算: あり

供託:
  - 和了者が取得
  - ダブロン時は上家取り
  - 流局終了時はトップ取り

積み棒・親権:
  - ダブロン時は上家取り
```

## 14. 祝儀

```
基本祝儀（各1枚）:
  - 一発
  - 裏ドラ（1枚でもあれば）
  - カン裏（1枚でもあれば）
  - 金牌（和了形に含まれる、副露手含む）
  - 白ポッチ（和了形に含まれる）

特殊祝儀:
  - トビ祝儀: 飛ばした者に2枚（ダブロン時は分ける）
  - 本役満祝儀: ツモ5枚オール、ロン10枚
  - 数え役満: 13翻超えで1翻ごとに1枚（例: 15翻=2枚）
  - 金オールスター: 3つの金牌すべて和了形に含む、ツモ5枚オール、ロン5枚
  - 花四: 4枚抜きでの和了、本役満祝儀

祝儀の非複合:
  - 金牌祝儀と金オールスター祝儀
  - 金花祝儀と花四祝儀

その他の祝儀は複合する
```

## 15. 優先順位・同時処理

```
競技行為の優先順位:
  1. 和了（ロン）
  2. ポン・カン
  3. ツモ

同時ロン（ダブロン）:
  - 可能
  - 放銃者は2人分の点数を支払う
  - 供託・積み棒・親権は上家取り

槍槓:
  - 槓不成立のため槓ドラはめくらない
  - 国士無双のみ暗槓への槍槓あり（暗槓した者が放銃者）
```

## 16. 特殊な和了形・状況

```
天和・地和・人和の判定:
  - 天和: 親の配牌時点（第一打前）
  - 地和: 子の第一ツモ（副露がない状態）
  - 人和: 第一巡の他家の打牌でのロン（副露がない状態）

流し（役満）:
  - 1打目から海底牌まで継続
  - 自分は副露しない
  - 他家も自分の捨て牌を副露しない
  - 幺九牌のみ河に捨てる
  - 流局成立で役満
  - 自分が副露した時点、または他家が自分の牌を副露した時点で終了

カラス（役満）:
  - リーチのみ1翻
  - ドラ0枚
  - 計1翻での和了

オープンリーチの押し出し:
  - オープンリーチ者に対して
  - 手牌すべてがオープンリーチ者の和了牌
  - 放銃せざるを得ない状況
  - 役満払い
```

## 17. ゲームフロー（実装用）

```
【ゲーム開始】
1. 座位決定（東・南・西）
2. 起親決定
3. 配給原点配布（各50,000点）

【半荘開始】
1. 東一局0本場から開始

【1局の流れ】
1. 配牌
   - 子: 13枚
   - 親: 14枚
2. ドラ表示牌を開示
3. 親の第一打でゲーム開始
4. ツモ→打牌を繰り返す
   - 華牌は自動抜き（嶺上牌をツモ、王牌-1）
   - 副露処理（ポン・カン）
   - リーチ処理
5. 和了または流局
6. 点数授受・祝儀授受
7. 連荘/輪荘判定
8. トビ判定
9. ゲーム終了判定
   - 南場終了？
   - トビ発生？
   - オーラスでトップがやめ選択？
10. 継続なら次局へ

【ゲーム終了】
1. 合計点調整
2. 順位決定
3. ウマ計算
4. 箱下精算
5. 最終得点確定
```

---

## 補足：実装上の注意事項

### 和了判定の詳細

**基本和了形の判定:**
- 手牌13枚 + ツモ/ロン牌1枚 = 14枚
- 副露牌を含めて14枚で判定
- 雀頭1組 + 面子4組の構成
- 特殊形：七対子、十三幺九

**役判定の順序:**
1. 和了形確定（高点法適用）
2. 役の判定と翻数計算
3. ドラ枚数加算
4. 点数表参照
5. 積み棒加算
6. 親子・ツモロン判定

**フリテン判定:**
- 自分の河に和了牌があるか確認
- リーチ時は全ての待ち牌で判定
- フリテンはロン不可、ツモのみ可

### ドラの判定

**次順牌の計算:**
```
数牌: (n % 9) + 1
風牌: 東(0)→南(1)→西(2)→北(3)→東(0)
三元牌: 白(0)→發(1)→中(2)→白(0)
華牌: そのまま華牌
```

**赤ドラの扱い:**
- 5筒・5索は自動的に赤ドラ
- 通常の5としても扱う
- 白ポッチは金牌にはならない

### 状態管理

**ゲーム状態:**
- 現在の局（東一～南三）
- 本場カウント
- 親番（東家固定、実プレイヤーが回る）
- 供託本数
- 各プレイヤーの持ち点
- リーチ状態

**局の状態:**
- 残り牌数
- 王牌枚数
- ドラ表示枚数
- 各プレイヤーの手牌
- 各プレイヤーの河
- 各プレイヤーの副露牌
- 各プレイヤーの抜いた華牌

**プレイヤー状態:**
- 手牌13～17枚
- 門前清フラグ
- リーチフラグ
- オープンリーチフラグ
- 一発フラグ
- ダブルリーチフラグ
- 流し継続フラグ

### エッジケースの処理

**同時発声:**
- ロン > ポン・カン
- ダブロン可能
- 上家優先（供託・積み棒・親権）

**槍槓:**
- 加槓時のロンは槍槓
- 槓不成立、槓ドラめくらない
- 国士無双のみ暗槓も槍槓可能

**オーラス処理:**
- トップの親のみ選択権
- 和了やめ・聴牌やめ
- 続行なら連荘継続

**トビ処理:**
- 0点以下で即終了
- トビ祝儀2枚
- ダブロン時は祝儀を分ける

### 王牌の動的管理

**王牌の変動計算:**
```
王牌枚数 = 10 - (華牌抜き回数) + (槓回数)
最小値: 6枚（華牌4枚全抜き）
最大値: 14枚（槓4回）
```

**嶺上牌の位置:**
```
嶺上牌は常に王牌の末尾（牌山リストの最後尾）
華牌抜きまたは槓のたびに嶺上牌をツモる
```

**海底牌の動的判定:**
```
海底牌 = 王牌の直前の牌
王牌枚数の変動に応じて海底牌の位置も変わる
```

---

## 18. pt計算（最終精算）

```
【計算式】
最終pt = (最終点数 - 配給原点) / 1,000 + ウマ + 祝儀枚数 × 5

配給原点: 50,000点

【ウマ表】
条件: 2着の最終点数で判定

2着が浮き（50,000点超過）の場合:
  - 1着: +30pt
  - 2着: +10pt
  - 3着: -40pt

2着が沈み（50,000点未満）の場合:
  - 1着: +40pt
  - 2着: -10pt
  - 3着: -30pt

【計算例】
プレイヤーA: 80,000点（1着）、祝儀+3枚
プレイヤーB: 55,000点（2着）、祝儀+2枚
プレイヤーC: 15,000点（3着）、祝儀-5枚

2着が浮き(55,000 > 50,000)なので:
  A: (80,000 - 50,000)/1,000 + 30 + 3×5 = 30 + 30 + 15 = +75pt
  B: (55,000 - 50,000)/1,000 + 10 + 2×5 = 5 + 10 + 10 = +25pt
  C: (15,000 - 50,000)/1,000 - 40 + (-5)×5 = -35 - 40 - 25 = -100pt
```

---

## 19. 実装上の追加補足

### 金牌について
- **定義**: 5p、5s、花牌に各1枚存在（計3枚）
- **性質**: 赤ドラの一部であり、同時に祝儀対象
- **祝儀**: 和了時に手牌に含まれる金牌1枚につき祝儀+1枚
- **金オールスター**: 3つの金牌すべてを和了形に含む場合、特別祝儀

### 白ポッチについて
- **定義**: 白の4枚のうち1枚
- **リーチ後効果**: リーチ宣言後にツモした場合、**自動和了**（強制）
- **オールマイティ**: 任意の牌として扱える（高め取り可能）
- **赤ドラ**: 和了牌に5がある場合、赤ドラとして扱える
- **金牌**: 白ポッチは金牌にはならない
- **祝儀**: 和了形に白ポッチが含まれる場合、祝儀+1枚

### 華牌の処理
- **空気扱い**: 手牌としてカウントしない
- **自動抜き**: 配牌時・ツモ時に華牌があれば即座に抜く
- **補充**: 嶺上牌から補充して手牌を14枚（ツモ後）に保つ
- **王牌変動**: 華牌を抜くたび王牌-1枚
- **状態継続**: 一発・海底等の状態は消えない
- **嶺上開花**: 華牌抜きでの補充時はつかない

### ダブロン時の処理
- **供託・積み棒・親権**: 放銃者から見て**下家**（反時計回りで近い方）が取得
- **点数**: 放銃者は2人分の点数を支払う
- **祝儀**: 各和了者がそれぞれの祝儀を得る

### 押し出し（特殊役満）
- **条件**: オープンリーチ者に対し、手牌すべてがオープンリーチ者の和了牌
- **結果**: 打牌せざるを得ない → 役満払い
- **判定**: オープンリーチ者の待ち牌と手牌を比較

### 4枚使い七対子
- **基本**: 七対子（2翻）
- **加算**: 同じ牌4枚で対子2組を構成する場合（=4枚使い1組）、+4翻
- **例1**: 1111223344556677 → 1の4枚使い1組 → 七対子(2翻) + 4枚使い1組(+4翻) = 6翻
- **例2**: 1111222233445566 → 1と2の4枚使い2組 → 七対子(2翻) + 4枚使い2組(+8翻) = 10翻

### 食い換え
- 本実装では無視（チェック不要）

---

以上
